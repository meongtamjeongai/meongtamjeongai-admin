# ì›Œí¬í”Œë¡œìš°ì˜ ìµœìƒë‹¨ì— ìœ„ì¹˜í•˜ë©°, GitHub Actions UIì˜ ì›Œí¬í”Œë¡œìš° ëª©ë¡ì— í‘œì‹œë  ì´ë¦„ì…ë‹ˆë‹¤.
# ì´ëª¨ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œê°ì ìœ¼ë¡œ êµ¬ë¶„í•˜ë©´ í¸ë¦¬í•©ë‹ˆë‹¤.
name: "ğŸ¨ [Admin] Build, Push to ECR & Deploy via SSM"

# 'run-name'ì€ ê°œë³„ ì‹¤í–‰(Run)ì˜ ì´ë¦„ì„ ë™ì ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
# ì´ë¥¼ í†µí•´ Actions ì‹¤í–‰ ê¸°ë¡ì—ì„œ ê° ë°°í¬ì˜ ëª©ì ì„ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
# ì˜ˆ: "ğŸ¨ Admin Deploy | UI ë²„ê·¸ ìˆ˜ì • | by @github_user"
run-name: "ğŸ¨ Admin Deploy | ${{ github.event.inputs.run_description }} | by @${{ github.actor }}"

# 'on' ì„¹ì…˜ì€ ì´ ì›Œí¬í”Œë¡œìš°ê°€ ì–¸ì œ ì‹¤í–‰ë ì§€ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
on:
  # 'workflow_dispatch'ëŠ” GitHub UIì—ì„œ "Run workflow" ë²„íŠ¼ì„ ëˆŒëŸ¬ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
  workflow_dispatch:
    # 'inputs' ì„¹ì…˜ì€ ìˆ˜ë™ ì‹¤í–‰ ì‹œ ì‚¬ìš©ìë¡œë¶€í„° ë°›ì„ íŒŒë¼ë¯¸í„°ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
    inputs:
      git_ref:
        description: "ë¹Œë“œí•  Git ì°¸ì¡° (ë¸Œëœì¹˜, íƒœê·¸ ë˜ëŠ” ì»¤ë°‹ SHA)"
        required: true
        default: "main" # ê¸°ë³¸ì ìœ¼ë¡œ 'main' ë¸Œëœì¹˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
      run_description:
        description: "ğŸ’¬ ì´ ë°°í¬ì˜ ëª©ì ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì‚¬ìš©ì UI ê°œì„ )"
        required: true
        default: "Regular Manual Deployment" # ê¸°ë³¸ ì„¤ëª…

# 'permissions'ëŠ” ì´ ì›Œí¬í”Œë¡œìš°ê°€ GitHub APIì™€ ìƒí˜¸ì‘ìš©í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ê¶Œí•œì„ ì •ì˜í•©ë‹ˆë‹¤.
permissions:
  id-token: write # AWS OIDC ì¸ì¦ì„ ìœ„í•´ ID í† í°ì„ ë°œê¸‰ë°›ì„ ê¶Œí•œ
  contents: read # ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ì½ì„(checkout) ê¶Œí•œ

# 'env'ëŠ” ì´ ì›Œí¬í”Œë¡œìš°ì˜ ëª¨ë“  ì¡(job)ì—ì„œ ê³µí†µì ìœ¼ë¡œ ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
# GitHub Secretsë¥¼ ì‚¬ìš©í•˜ì—¬ ë¯¼ê°í•œ ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•©ë‹ˆë‹¤.
env:
  AWS_REGION: ${{ secrets.AWS_REGION }} # ë°°í¬í•  AWS ë¦¬ì „
  ECR_REPOSITORY: ${{ secrets.ADMIN_ECR_REPOSITORY }} # ê´€ë¦¬ì ì•± ì´ë¯¸ì§€ë¥¼ ì €ì¥í•  ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„
  CONTAINER_NAME: admin-app-container # EC2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì‹¤í–‰ë  ì»¨í…Œì´ë„ˆì˜ ì´ë¦„
  HOST_PORT: ${{ secrets.ADMIN_HOST_PORT }} # EC2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë…¸ì¶œí•  í¬íŠ¸ (ì˜ˆ: 8501)
  CONTAINER_PORT: ${{ secrets.ADMIN_CONTAINER_PORT }} # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì•±ì´ ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ (ì˜ˆ: 8501)
  # â­ï¸ ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€
  ALB_PRIVATE_IP: ${{ secrets.ALB_PRIVATE_IP }} # FastAPI ë°±ì—”ë“œ ALBì˜ í”„ë¼ì´ë¹— IP ì£¼ì†Œ
  FASTAPI_BASE_URL: ${{ secrets.FASTAPI_BASE_URL }} # ê´€ë¦¬ì ì•±ì´ í˜¸ì¶œí•  FastAPIì˜ ì „ì²´ URL (ì˜ˆ: https://meong.shop/api/v1)

# 'jobs'ëŠ” ì›Œí¬í”Œë¡œìš°ë¥¼ êµ¬ì„±í•˜ëŠ” ì‹¤ì œ ì‘ì—… ë‹¨ìœ„ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.
jobs:
  # ì²« ë²ˆì§¸ ì¡: ì‹¤í–‰ ì •ë³´ë¥¼ ë³´ê¸° ì¢‹ê²Œ ì¶œë ¥í•©ë‹ˆë‹¤. (ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ê¶Œì¥)
  print_run_info:
    name: 0. Print Run Information
    runs-on: ubuntu-latest
    steps:
      - name: Display run parameters
        run: |
          # GitHub Actionsì˜ 'Summary' íƒ­ì— ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‹¤í–‰ ì •ë³´ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.
          echo "### ğŸ¨ Admin App Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Git Ref** | \`${{ github.event.inputs.git_ref }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Description** | ${{ github.event.inputs.run_description }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | `@${{ github.actor }}` |" >> $GITHUB_STEP_SUMMARY

  # ë‘ ë²ˆì§¸ ì¡: ì½”ë“œë¥¼ ë¹Œë“œí•˜ê³ , ì´ë¯¸ì§€ë¥¼ ECRì— í‘¸ì‹œí•˜ê³ , EC2ì— ë°°í¬í•©ë‹ˆë‹¤.
  build-and-deploy:
    name: Build, Push to ECR, and Deploy to EC2
    runs-on: ubuntu-latest
    needs: print_run_info # 'print_run_info' ì¡ì´ ì„±ê³µí•´ì•¼ ì´ ì¡ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref }} # ì‚¬ìš©ìê°€ ì…ë ¥í•œ Git ì°¸ì¡°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

      # 2. AWS ìê²© ì¦ëª… ì„¤ì • (OIDC ë°©ì‹)
      # Access Keyë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•Šê³ , GitHub Actionsì™€ AWS ê°„ì˜ ì‹ ë¢° ê´€ê³„ë¥¼ í†µí•´
      # ì„ì‹œ ìê²© ì¦ëª…ì„ ì•ˆì „í•˜ê²Œ ë°œê¸‰ë°›ìŠµë‹ˆë‹¤.
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_ARN }} # ì´ ì›Œí¬í”Œë¡œìš°ê°€ ìœ„ì„ë°›ì„ IAM ì—­í• ì˜ ARN
          aws-region: ${{ env.AWS_REGION }}

      # 3. Amazon ECR ë¡œê·¸ì¸
      # ìœ„ì—ì„œ ì–»ì€ AWS ìê²© ì¦ëª…ì„ ì‚¬ìš©í•˜ì—¬ ECRì— ë¡œê·¸ì¸í•©ë‹ˆë‹¤.
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECRì— í‘¸ì‹œ
      # ì†ŒìŠ¤ ì½”ë“œë¥¼ Dockerfileì„ ê¸°ë°˜ìœ¼ë¡œ ë¹Œë“œí•˜ê³ , ECRì— ì—…ë¡œë“œí•©ë‹ˆë‹¤.
      - name: Build, tag, and push image to Amazon ECR
        id: build-and-push-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }} # ECR ë¡œê·¸ì¸ ê²°ê³¼ë¡œ ì–»ì€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì£¼ì†Œ
          IMAGE_TAG: ${{ github.sha }} # ì»¤ë°‹ í•´ì‹œë¥¼ ì´ë¯¸ì§€ íƒœê·¸ë¡œ ì‚¬ìš©í•˜ì—¬ ë²„ì „ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
        uses: docker/build-push-action@v5
        with:
          context: . # Dockerfileì´ ìˆëŠ” í˜„ì¬ ë””ë ‰í† ë¦¬
          push: true # ë¹Œë“œ í›„ ECRì— í‘¸ì‹œ
          tags: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} # ìµœì¢… ì´ë¯¸ì§€ URI (ì˜ˆ: 123456789012.dkr.ecr.ap-northeast-2.amazonaws.com/my-admin-repo:abcdef1)

      # 5. SSM Send-Commandë¥¼ í†µí•´ EC2 ì¸ìŠ¤í„´ìŠ¤ì— ë°°í¬
      # SSH ì—†ì´ AWS Systems Managerë¥¼ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•˜ê²Œ EC2ì— ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
      - name: Deploy to EC2 instance via SSM
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -e # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•©ë‹ˆë‹¤.

          # ë³€ìˆ˜ ìœ íš¨ì„± ê²€ì‚¬
          if [ -z "$HOST_PORT" ] || [ -z "$CONTAINER_PORT" ] || [ -z "$ALB_PRIVATE_IP" ] || [ -z "$FASTAPI_BASE_URL" ]; then
            echo "::error:: One or more required secrets (HOST_PORT, CONTAINER_PORT, ALB_PRIVATE_IP, FASTAPI_BASE_URL) are not set."
            exit 1
          fi

          # EC2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì‹¤í–‰ë  ì „ì²´ ì‰˜ ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš©ì„ ì—¬ê¸°ì— ì •ì˜í•©ë‹ˆë‹¤.
          # 'EOF'ëŠ” Here Document ë¬¸ë²•ìœ¼ë¡œ, ì—¬ëŸ¬ ì¤„ì˜ ë¬¸ìì—´ì„ ë³€ìˆ˜ì— ì‰½ê²Œ í• ë‹¹í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
          COMMAND_SCRIPT=$(cat <<'EOF'
          set -e

          # â­ï¸ í•´ê²°ì±… 1: /etc/hosts íŒŒì¼ ìˆ˜ì •í•˜ì—¬ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ í†µì‹  ë¬¸ì œ í•´ê²°
          echo ">>> Updating /etc/hosts for internal communication..."
          # ê¸°ì¡´ì— 'meong.shop' ë„ë©”ì¸ì— ëŒ€í•œ ì„¤ì •ì´ ìˆë‹¤ë©´ ì‚­ì œí•©ë‹ˆë‹¤.
          sudo sed -i '/meong.shop/d' /etc/hosts
          # ALBì˜ í”„ë¼ì´ë¹— IPë¥¼ 'meong.shop'ê³¼ 'admin.meong.shop' ë„ë©”ì¸ì— ë§¤í•‘í•©ë‹ˆë‹¤.
          echo "__ALB_PRIVATE_IP__ meong.shop admin.meong.shop" | sudo tee -a /etc/hosts
          echo "âœ… /etc/hosts updated successfully."

          # 1. ECR ë¡œê·¸ì¸
          echo ">>> Logging into ECR from EC2 instance..."
          aws ecr get-login-password --region __AWS_REGION__ | sudo docker login --username AWS --password-stdin __ECR_REGISTRY__

          # 2. ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
          echo ">>> Pulling new image: __FULL_IMAGE_URI__"
          sudo docker pull __FULL_IMAGE_URI__

          # 3. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
          echo ">>> Stopping and removing old container if it exists..."
          # -f name=__CONTAINER_NAME__ : ì´ë¦„ìœ¼ë¡œ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ìŠµë‹ˆë‹¤.
          # -q : ì»¨í…Œì´ë„ˆ IDë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.
          if [ $(sudo docker ps -q -f name=__CONTAINER_NAME__) ]; then sudo docker stop __CONTAINER_NAME__; fi
          if [ $(sudo docker ps -aq -f name=__CONTAINER_NAME__) ]; then sudo docker rm __CONTAINER_NAME__; fi

          # 4. ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          echo ">>> Starting new container..."
          sudo docker run -d \
            --name __CONTAINER_NAME__ \
            -p __HOST_PORT__:__CONTAINER_PORT__ \
            --restart always \
            -e FASTAPI_API_BASE_URL="__FASTAPI_BASE_URL__" \
            -e SECRET_SIGNUP_MODE="true" \
            __FULL_IMAGE_URI__

          # 5. ë¶ˆí•„ìš”í•œ Docker ì´ë¯¸ì§€ ì •ë¦¬
          echo ">>> Pruning old docker images..."
          sudo docker image prune -af

          echo "âœ… Deployment script finished successfully on EC2."
          EOF
          )

          # ìœ„ ìŠ¤í¬ë¦½íŠ¸ì˜ __PLACEHOLDER__ ë¶€ë¶„ì„ ì‹¤ì œ ê°’ìœ¼ë¡œ ì¹˜í™˜í•©ë‹ˆë‹¤.
          FULL_IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__AWS_REGION__/${AWS_REGION}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__ECR_REGISTRY__/${ECR_REGISTRY}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__FULL_IMAGE_URI__/${FULL_IMAGE_URI}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__CONTAINER_NAME__/${CONTAINER_NAME}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__HOST_PORT__/${HOST_PORT}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__CONTAINER_PORT__/${CONTAINER_PORT}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__ALB_PRIVATE_IP__/${ALB_PRIVATE_IP}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__FASTAPI_BASE_URL__/${FASTAPI_BASE_URL}}"

          # SSM íŒŒë¼ë¯¸í„°ëŠ” JSON í˜•ì‹ì„ ë”°ë¥´ë¯€ë¡œ, jqë¥¼ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•˜ê²Œ ìƒì„±í•©ë‹ˆë‹¤.
          SSM_PARAMETERS=$(jq -n --arg script "$COMMAND_SCRIPT" '{ "commands": ($script | split("\n")) }')

          echo ">>> Sending deployment command to EC2 instance via SSM..."
          aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy image tag ${{ env.IMAGE_TAG }} via GitHub Actions" \
            --parameters "$SSM_PARAMETERS"
