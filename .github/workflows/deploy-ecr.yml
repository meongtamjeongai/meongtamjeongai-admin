name: CI/CD to AWS ECR and Deploy to EC2

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
  CONTAINER_NAME: my-app-container
  # ğŸ¯ ì¶”ê°€: í¬íŠ¸ ê´€ë ¨ Secretsë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
  HOST_PORT: ${{ secrets.HOST_PORT }}
  CONTAINER_PORT: ${{ secrets.CONTAINER_PORT }}

jobs:
  build-and-deploy:
    name: Build, Push to ECR, and Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (ì´ì „ê³¼ ë™ì¼)
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2. AWS ìê²© ì¦ëª… ì„¤ì • (OIDC, ì´ì „ê³¼ ë™ì¼)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # 3. Amazon ECR ë¡œê·¸ì¸ (ì´ì „ê³¼ ë™ì¼)
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ, íƒœê·¸ ì§€ì • ë° ECRì— í‘¸ì‹œ (ì´ì „ê³¼ ë™ì¼)
      - name: Build, tag, and push image to Amazon ECR
        id: build-and-push-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}

      # 5. SSM Send-Commandë¥¼ í†µí•´ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ìˆ˜ì •ëœ ë¶€ë¶„)
      - name: Deploy to EC2 instance via SSM
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -e
          
          # ë³€ìˆ˜ ìœ íš¨ì„± ê²€ì‚¬
          if [ -z "$HOST_PORT" ] || [ -z "$CONTAINER_PORT" ]; then
            echo "::error:: HOST_PORT or CONTAINER_PORT secret is not set."
            exit 1
          fi
          
          # ì‹¤í–‰í•  ì‰˜ ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš©ì„ ë³€ìˆ˜ì— ì €ì¥ (í…œí”Œë¦¿ ì—­í• )
          # ë³€ìˆ˜ë“¤ì€ __PLACEHOLDER__ í˜•íƒœë¡œ ë‘ê³  ë‚˜ì¤‘ì— ì¹˜í™˜
          COMMAND_SCRIPT=$(cat <<'EOF'
          set -e
          echo "Logging into ECR from EC2 instance..."
          aws ecr get-login-password --region __AWS_REGION__ | sudo docker login --username AWS --password-stdin __ECR_REGISTRY__
          echo "Pulling new image: __FULL_IMAGE_URI__"
          sudo docker pull __FULL_IMAGE_URI__
          echo "Stopping and removing old container..."
          if [ $(sudo docker ps -q -f name=__CONTAINER_NAME__) ]; then sudo docker stop __CONTAINER_NAME__; fi
          if [ $(sudo docker ps -aq -f name=__CONTAINER_NAME__) ]; then sudo docker rm __CONTAINER_NAME__; fi
          echo "Starting new container on host port __HOST_PORT__ mapping to container port __CONTAINER_PORT__..."
          sudo docker run -d --name __CONTAINER_NAME__ -p __HOST_PORT__:__CONTAINER_PORT__ --restart always __FULL_IMAGE_URI__
          echo "Pruning old docker images..."
          sudo docker image prune -af
          EOF
          )
          
          # í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ ì¹˜í™˜
          FULL_IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__AWS_REGION__/${AWS_REGION}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__ECR_REGISTRY__/${ECR_REGISTRY}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__FULL_IMAGE_URI__/${FULL_IMAGE_URI}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__CONTAINER_NAME__/${CONTAINER_NAME}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__HOST_PORT__/${HOST_PORT}}"
          COMMAND_SCRIPT="${COMMAND_SCRIPT//__CONTAINER_PORT__/${CONTAINER_PORT}}"
          
          # jqë¥¼ ì‚¬ìš©í•˜ì—¬ SSM íŒŒë¼ë¯¸í„°ìš© JSONì„ ì•ˆì „í•˜ê²Œ ìƒì„±
          SSM_PARAMETERS=$(jq -n --arg script "$COMMAND_SCRIPT" '{ "commands": ($script | split("\n")) }')

          echo "Sending deployment command to EC2 instance via SSM..."
          aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploying ${FULL_IMAGE_URI}" \
            --parameters "$SSM_PARAMETERS"